# Витрина RFM

## 1.1. Выясним требования к целевой витрине.

Задача: Подготовить витрину для для RFM-анализа. Для анализа нужно отобрать только успешно выполненные заказы, которые имеют статус closed;
Согласованное название витрины: dm_rfm_segments;
Глубина требуемых данных: с начала 2022 года;
Обновления: не требуются;
Хранение: в БД - de, схеме - analysis;
Сроки выполнения: нет условия.

Структура построенной витрины: 

user_id - идентификатор клиента;
recency (число от 1 до 5) - время с последнего заказа, где 1 означает, что клиент, либо совсем не делал заказов, либо давно и 5 — те, кто заказывал относительно недавно;
frequency (число от 1 до 5) - категоризация по кол-ву заказов, где 1 минимальное кол-во, а 5 наибольшее кол-во;
monetary_value (число от 1 до 5) - распределение по суммам трат клиентов, где 1 меньшее и 5 большее. 

## 1.2. Изучим структуру исходных данных.

Доступны следующие 6 таблиц:

orders - в таблице предоставлены данные по заказам
orderitems - детализация заказов
orderstatuses - в данной таблице хранятся статусы заказов
orderstatuslog - суда записываются логи заказов 
products - таблица с информацией о продукции 
users - информация о клиентах 

Для построения витрины будем использовать таблицу - production.orders, где будет поле status будет фильтроваться по условию closed (4). Используемые поля: 
order_id - идентификатор заказа
order_ts - дата и время заказа
user_id - идентификатор клиента
cost - сумма оплаты 
status - статус заказа

Так же используется таблица - production.users:
id - идентификатор клиента 

## 1.3. Проанализируем качество данных

Пропущенные значения и дубликаты отсутствуют.(is null, distinct).

На данные установлены ограничения повышающие качество данных: 
таблица production.orders
order_id int4 NOT NULL - не может быть нулевых значений в айди заказа
order_ts timestamp NOT NULL, - для времени заказа уже установлен верный формат(timestamp) и ограничения нулевых значений 
"cost" numeric(19, 5) NOT NULL DEFAULT 0, - значения по дефолту не могут быть нулевыми
status int4 NOT NULL статус не может быть нулевым

Выделим отдельно уставлена проверка на сумму коста (финального платежа) и ограничение по первичному ключу по столбцу order_id
CONSTRAINT orders_check CHECK ((cost = (payment + bonus_payment)))
CONSTRAINT orders_pkey PRIMARY KEY (order_id)

production.users: 
id int4 NOT NULL идентификатор не может быть нулевым для клиентов 
CONSTRAINT users_pkey PRIMARY KEY (id) установлены ограничения по первичному ключу 
